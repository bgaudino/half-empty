{% extends 'base.html' %}

{% block javascript %}
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block content %}
  {% include 'quotes/partials/_quote.html' %}
  <div class="p-card">
    <form
      id="todoCreateForm"
      hx-post="{% url 'todo_create' %}" 
      hx-include="[name='tags']"
      hx-target="#todos"
      hx-swap="beforeend show:#todos:bottom"
    >
      {% csrf_token %}
      <div class="addTodo">
        {{ add_todo_form.name }}
        <button aria-label="Show more" data-show-controls=".addTodoFields" type="button"><i class="fa-solid fa-chevron-down"></i></button>
      </div>
      <div class="u-hide addTodoFields">
        {{ add_todo_form.deadline.label_tag }}
        {{ add_todo_form.deadline }}
        {{ add_todo_form.description.label_tag }}
        {{ add_todo_form.description }}
      </div>
    </form>
    <form 
      id="tagForm"
      class="u-hide addTodoFields"
      hx-post="{% url 'add_tag' %}"
      hx-target="this"
      hx-swap="innerHTML"
    >
      {% include 'todos/partials/_tag_form.html' %}
    </form>
    <button class="u-hide addTodoFields p-button--brand" type="submit" form="todoCreateForm">Add</button>
    <h3>My Todos</h3>
    <a id="filtersToggle">Show Filters</a>
    <form
      id="filtersForm"
      hx-get="{% url 'todo_list' %}"
      hx-swap="outerHTML"
      hx-target="#todos"
      hx-push-url="true"
      class="u-hide"
    >
      {{ filter_todos_form.tag.label_tag }}
      {{ filter_todos_form.tag }}
      {{ filter_todos_form.deadline_start.label_tag }}
      {{ filter_todos_form.deadline_start }}
      {{ filter_todos_form.deadline_end.label_tag }}
      {{ filter_todos_form.deadline_end }}
      <label class="p-checkbox">
        <input
          type="checkbox"
          name="completed"
          aria-labelledby="completedLabel"
          class="p-checkbox__input"
          {% if request.GET.completed == 'on' %}
            checked
          {% endif %}
        >
        <span class="p-checkbox__label" id="completedLabel">{{ filter_todos_form.completed.label }}</span>
      </label>
      <label class="p-checkbox">
        <input
          type="checkbox"
          name="in_trash"
          aria-labelledby="inTrashLabel"
          class="p-checkbox__input"
          {% if request.GET.in_trash == 'on' %}
            checked
          {% endif %}
        >
        <span class="p-checkbox__label" id="inTrashLabel">{{ filter_todos_form.in_trash.label }}</span>
      </label>
      <button type="button" id="clearFiltersButton">Clear Filters</button>
      <button type="submit">Apply Filters</button>
    </form>
    {% include 'todos/partials/_todo_list.html' %}
  </div>
    <script>
      document.addEventListener('htmx:afterRequest', function({detail}) {
        if (detail.requestConfig.elt.id == 'todoCreateForm' && detail.successful) {
          detail.requestConfig.elt.reset();
          const toggle = document.querySelector('[data-show-controls]');
          if (toggle.querySelector('i').classList.contains('fa-chevron-up')) {
            toggle.click();
          }
        } 
      });
      for (const toggle of document.querySelectorAll('[data-show-controls]')) {
        toggle.onclick = function() {
          for (const element of document.querySelectorAll(toggle.dataset.showControls)) {
            element.classList.toggle('u-hide');
          }
          const icon = toggle.querySelector('i');
          const classes = ['fa-chevron-down', 'fa-chevron-up'];
          if (icon.classList.contains(classes[1])) {
            classes.reverse();
          }
          icon.classList.remove(classes[0]);
          icon.classList.add(classes[1]);
      }}
      document.getElementById('filtersToggle').onclick = function(e) {
        document.getElementById('filtersForm').classList.toggle('u-hide');
        e.target.innerText = e.target.innerText === 'Show Filters' ? 'Hide Filters' : 'Show Filters';
      }
      document.getElementById('clearFiltersButton').onclick = function() {
        const form = document.getElementById('filtersForm');
        for (const element of form.querySelectorAll('input:not(hidden)')) {
          if (element.type === 'checkbox') {
            element.checked = false;
          } else {
            element.value = '';
          }
        }
        form.querySelector('button[type="submit"]').click();
      }
  </script>
{% endblock %}